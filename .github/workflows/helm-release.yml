name: Release Helm Chart

on:
  push:
    tags:
      - "v*.*.*"
jobs:
  helm:
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.3'
      - name: Set Version
        id: set_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      - name: Update Image Tag
        run: |
          sed -i "s/tag: .*/tag: $VERSION/" deploy/charts/kmesh-helm/values.yaml
      - name: Login to Github Container Registry
        run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u $ --password-stdin    
      - name: Build and Push the Helm Charts to GitHub Container Registry
        run: |
          make helm-push VERSION=$VERSION CHART_VERSION=$VERSION HUB=ghcr.io/hzxuzhonghu
